#!/bin/bash

# ============================================
# 电商出入库系统配置脚本
# ============================================

set -e

echo "========================================"
echo "  电商出入库系统 - 配置向导"
echo "========================================"
echo ""

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 询问配置内容
echo "请选择要配置的内容:"
echo "  1) 完整系统（前端 + 后端）"
echo "  2) 仅后端"
echo "  3) 仅前端"
read -r config_choice

SETUP_SERVER=false
SETUP_WEB=false

case $config_choice in
    1)
        SETUP_SERVER=true
        SETUP_WEB=true
        echo -e "${GREEN}✓${NC} 将配置完整系统"
        ;;
    2)
        SETUP_SERVER=true
        echo -e "${GREEN}✓${NC} 将配置后端"
        ;;
    3)
        SETUP_WEB=true
        echo -e "${GREEN}✓${NC} 将配置前端"
        ;;
    *)
        echo -e "${RED}无效选择，默认配置完整系统${NC}"
        SETUP_SERVER=true
        SETUP_WEB=true
        ;;
esac

echo ""

# 检查命令是否存在
check_command() {
    if command -v "$1" &> /dev/null; then
        echo -e "${GREEN}✓${NC} $1 已安装"
        return 0
    else
        echo -e "${RED}✗${NC} $1 未安装"
        return 1
    fi
}

# 检查 Python 版本
check_python() {
    local python_cmd=$1
    if command -v "$python_cmd" &> /dev/null; then
        local version=$($python_cmd --version 2>&1 | awk '{print $2}')
        local major=$(echo $version | cut -d. -f1)
        local minor=$(echo $version | cut -d. -f2)
        
        if [ "$major" -ge 3 ] && [ "$minor" -ge 8 ]; then
            echo -e "${GREEN}✓${NC} $python_cmd $version (满足要求 >= 3.8)"
            return 0
        else
            echo -e "${YELLOW}⚠${NC} $python_cmd $version (建议 >= 3.8)"
            return 1
        fi
    fi
    return 1
}

# 检查 Node.js 版本
check_node() {
    if command -v node &> /dev/null; then
        local version=$(node --version | sed 's/v//')
        local major=$(echo $version | cut -d. -f1)
        
        if [ "$major" -ge 18 ]; then
            echo -e "${GREEN}✓${NC} Node.js $version (满足要求 >= 18)"
            return 0
        else
            echo -e "${YELLOW}⚠${NC} Node.js $version (建议 >= 18)"
            return 1
        fi
    fi
    return 1
}

echo "步骤 1/5: 检查系统环境"
echo "----------------------------------------"

# 显示需要检查的环境
if [ "$SETUP_SERVER" = true ] && [ "$SETUP_WEB" = true ]; then
    echo "需要检查: Python 和 Node.js"
elif [ "$SETUP_SERVER" = true ]; then
    echo "需要检查: Python"
elif [ "$SETUP_WEB" = true ]; then
    echo "需要检查: Node.js"
fi
echo ""

# 检测操作系统
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [ -f /etc/centos-release ]; then
        echo "centos"
    elif [ -f /etc/lsb-release ] && grep -q "Ubuntu" /etc/lsb-release; then
        echo "ubuntu"
    elif [ -f /etc/os-release ]; then
        if grep -q "Ubuntu" /etc/os-release; then
            echo "ubuntu"
        elif grep -q "CentOS" /etc/os-release; then
            echo "centos"
        else
            echo "unknown"
        fi
    else
        echo "unknown"
    fi
}

OS_TYPE=$(detect_os)
echo "检测到操作系统: $OS_TYPE"
echo ""

# 安装 Python
install_python() {
    echo ""
    echo "是否安装 Python 3? (y/n)"
    read -r install_py
    if [ "$install_py" != "y" ] && [ "$install_py" != "Y" ]; then
        echo -e "${RED}Python 是必需的，无法继续${NC}"
        exit 1
    fi
    
    case $OS_TYPE in
        macos)
            if ! command -v brew &> /dev/null; then
                echo "安装 Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            echo "使用 Homebrew 安装 Python3..."
            brew install python3
            ;;
        ubuntu)
            echo "使用 apt 安装 Python3..."
            sudo apt update
            sudo apt install -y python3 python3-pip
            ;;
        centos)
            echo "使用 yum 安装 Python3..."
            sudo yum install -y python3 python3-pip
            ;;
        *)
            echo -e "${RED}不支持的操作系统，请手动安装 Python 3.8+${NC}"
            exit 1
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓${NC} Python 安装成功"
    else
        echo -e "${RED}✗${NC} Python 安装失败"
        exit 1
    fi
}

# 安装 Node.js
install_nodejs() {
    echo ""
    echo "是否安装 Node.js? (y/n)"
    read -r install_node
    if [ "$install_node" != "y" ] && [ "$install_node" != "Y" ]; then
        echo -e "${RED}Node.js 是必需的，无法继续${NC}"
        exit 1
    fi
    
    case $OS_TYPE in
        macos)
            if ! command -v brew &> /dev/null; then
                echo "安装 Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            echo "使用 Homebrew 安装 Node.js..."
            brew install node
            ;;
        ubuntu)
            echo "使用 NodeSource 安装 Node.js 20.x..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            ;;
        centos)
            echo "使用 NodeSource 安装 Node.js 20.x..."
            curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
            sudo yum install -y nodejs
            ;;
        *)
            echo -e "${RED}不支持的操作系统，请手动安装 Node.js 18+${NC}"
            exit 1
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓${NC} Node.js 安装成功"
    else
        echo -e "${RED}✗${NC} Node.js 安装失败"
        exit 1
    fi
}

# 检测 Python（仅在需要后端时）
PYTHON_CMD=""
if [ "$SETUP_SERVER" = true ]; then
    if check_python "python3"; then
        PYTHON_CMD="python3"
    elif check_python "python"; then
        PYTHON_CMD="python"
    else
        echo -e "${YELLOW}未找到 Python 3.8+${NC}"
        install_python
        # 重新检测
        if check_python "python3"; then
            PYTHON_CMD="python3"
        elif check_python "python"; then
            PYTHON_CMD="python"
        else
            echo -e "${RED}Python 安装后仍无法检测到${NC}"
            exit 1
        fi
    fi
fi

# 检测 Node.js（仅在需要前端时）
if [ "$SETUP_WEB" = true ]; then
    if ! check_node; then
        echo -e "${YELLOW}未找到 Node.js 18+${NC}"
        install_nodejs
        # 重新检测
        if ! check_node; then
            echo -e "${RED}Node.js 安装后仍无法检测到${NC}"
            exit 1
        fi
    fi
    
    # 检测包管理器
    PACKAGE_MANAGER=""
    if check_command "pnpm"; then
        PACKAGE_MANAGER="pnpm"
    elif check_command "npm"; then
        PACKAGE_MANAGER="npm"
        echo ""
        echo -e "${BLUE}提示: 检测到 npm，推荐安装 pnpm 以获得更快的安装速度${NC}"
        echo "是否安装 pnpm? (y/n)"
        read -r install_pnpm
        if [ "$install_pnpm" = "y" ] || [ "$install_pnpm" = "Y" ]; then
            echo "安装 pnpm..."
            npm install -g pnpm
            if [ $? -eq 0 ]; then
                PACKAGE_MANAGER="pnpm"
                echo -e "${GREEN}✓${NC} pnpm 安装成功"
            else
                echo -e "${YELLOW}⚠${NC} pnpm 安装失败，将使用 npm"
            fi
        fi
    else
        echo -e "${RED}错误: 未找到 npm 或 pnpm${NC}"
        exit 1
    fi
fi

echo ""
echo "步骤 2/5: 配置后端环境"
echo "----------------------------------------"

SERVER_PORT=5274
LOG_LEVEL="INFO"

if [ "$SETUP_SERVER" = true ]; then
    # 检查后端目录
    if [ ! -d "server" ]; then
        echo -e "${RED}✗ 后端目录不存在${NC}"
        exit 1
    fi

    # 询问后端端口
    echo "请输入后端端口 (默认: 5274):"
    read -r server_port
    SERVER_PORT=${server_port:-5274}

    # 询问日志级别
    echo "请选择日志级别:"
    echo "  1) DEBUG   - 开发环境（详细日志）"
    echo "  2) INFO    - 测试环境（推荐）"
    echo "  3) WARNING - 生产环境（仅警告和错误）"
    read -r log_choice
    case $log_choice in
        1) LOG_LEVEL="DEBUG" ;;
        3) LOG_LEVEL="WARNING" ;;
        *) LOG_LEVEL="INFO" ;;
    esac

    # 直接生成后端环境变量文件
    cat > server/.env.development << EOF
# 后端环境变量配置
# 由 configure 脚本自动生成

# 日志级别: DEBUG | INFO | WARNING | ERROR | CRITICAL
LOG_LEVEL=$LOG_LEVEL

# 调试模式
DEBUG=True

# 服务器配置
HOST=0.0.0.0
PORT=$SERVER_PORT
EOF

    echo -e "${GREEN}✓${NC} 已生成 server/.env.development"

    # 检查 Python 依赖
    echo ""
    echo "检查 Python 依赖..."
    cd server
    
    if [ ! -f "requirements.txt" ]; then
        echo -e "${RED}✗${NC} 未找到 requirements.txt"
        cd ..
        exit 1
    fi
    
    # 获取已安装的包列表
    INSTALLED_PACKAGES=$($PYTHON_CMD -m pip list --format=freeze 2>/dev/null | tr '[:upper:]' '[:lower:]')
    
    # 解析 requirements.txt 并检查每个包
    MISSING_DEPS=()
    INSTALLED_COUNT=0
    TOTAL_COUNT=0
    
    while IFS= read -r line || [ -n "$line" ]; do
        # 跳过空行和注释
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        
        # 提取包名（去掉版本号）
        pkg_name=$(echo "$line" | sed 's/[>=<~!].*//' | tr '[:upper:]' '[:lower:]' | xargs)
        [ -z "$pkg_name" ] && continue
        
        TOTAL_COUNT=$((TOTAL_COUNT + 1))
        
        # 检查包是否已安装（使用 grep）
        if echo "$INSTALLED_PACKAGES" | grep -q "^${pkg_name}=="; then
            INSTALLED_COUNT=$((INSTALLED_COUNT + 1))
        else
            MISSING_DEPS+=("$pkg_name")
        fi
    done < requirements.txt
    
    echo "依赖检查: $INSTALLED_COUNT/$TOTAL_COUNT 已安装"
    
    if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
        echo -e "${YELLOW}缺失的依赖:${NC}"
        for dep in "${MISSING_DEPS[@]}"; do
            echo "  - $dep"
        done
        echo ""
        echo "是否安装缺失的 Python 依赖? (y/n)"
        read -r install_python_deps
        if [ "$install_python_deps" = "y" ] || [ "$install_python_deps" = "Y" ]; then
            echo "安装 Python 依赖..."
            $PYTHON_CMD -m pip install -r requirements.txt
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓${NC} Python 依赖安装成功"
            else
                echo -e "${RED}✗${NC} Python 依赖安装失败"
                cd ..
                exit 1
            fi
        else
            echo -e "${YELLOW}⚠${NC} 跳过依赖安装，可能导致运行失败"
        fi
    else
        echo -e "${GREEN}✓${NC} 所有 Python 依赖已安装"
        echo "是否重新安装 Python 依赖? (y/n)"
        read -r reinstall_python_deps
        if [ "$reinstall_python_deps" = "y" ] || [ "$reinstall_python_deps" = "Y" ]; then
            echo "重新安装 Python 依赖..."
            $PYTHON_CMD -m pip install --upgrade -r requirements.txt
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓${NC} Python 依赖重新安装成功"
            else
                echo -e "${RED}✗${NC} Python 依赖重新安装失败"
                cd ..
                exit 1
            fi
        fi
    fi
    
    cd ..
else
    echo "跳过后端配置"
fi

echo ""
echo "步骤 3/5: 配置前端环境"
echo "----------------------------------------"

WEB_PORT=5270

if [ "$SETUP_WEB" = true ]; then
    # 检查前端目录
    if [ ! -d "web" ]; then
        echo -e "${RED}✗ 前端目录不存在${NC}"
        exit 1
    fi

    # 询问前端端口
    echo "请输入前端端口 (默认: 5270):"
    read -r web_port
    WEB_PORT=${web_port:-5270}

    # 直接生成前端环境变量文件
    cat > web/.env.development << EOF
# 前端环境变量配置
# 由 configure 脚本自动生成

# API 基础地址
VITE_API_BASE_URL=http://localhost:$SERVER_PORT

# 应用标题
VITE_APP_TITLE=电商出入库系统
EOF

    echo -e "${GREEN}✓${NC} 已生成 web/.env.development"

    # 检查前端依赖
    echo ""
    echo "检查前端依赖..."
    cd web
    
    if [ -d "node_modules" ] && [ -f "node_modules/.package-lock.json" -o -f "node_modules/.pnpm-lock.yaml" ]; then
        echo -e "${GREEN}✓${NC} 前端依赖已安装"
        echo "是否重新安装前端依赖? (y/n)"
        read -r reinstall_node_deps
        if [ "$reinstall_node_deps" = "y" ] || [ "$reinstall_node_deps" = "Y" ]; then
            echo "使用 $PACKAGE_MANAGER 重新安装前端依赖..."
            $PACKAGE_MANAGER install
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓${NC} 前端依赖安装成功"
            else
                echo -e "${RED}✗${NC} 前端依赖安装失败"
                cd ..
                exit 1
            fi
        fi
    else
        echo -e "${YELLOW}检测到缺失的依赖${NC}"
        echo "是否安装前端依赖? (y/n)"
        read -r install_node_deps
        if [ "$install_node_deps" = "y" ] || [ "$install_node_deps" = "Y" ]; then
            echo "使用 $PACKAGE_MANAGER 安装前端依赖..."
            $PACKAGE_MANAGER install
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓${NC} 前端依赖安装成功"
            else
                echo -e "${RED}✗${NC} 前端依赖安装失败"
                cd ..
                exit 1
            fi
        else
            echo -e "${YELLOW}⚠${NC} 跳过依赖安装，可能导致运行失败"
        fi
    fi
    
    cd ..
else
    echo "跳过前端配置"
fi

echo ""
echo "步骤 4/5: 生成启动配置"
echo "----------------------------------------"

# 生成 config.sh
cat > config.sh << EOF
#!/bin/bash
# 此文件由 configure 脚本自动生成
# 请勿手动编辑

# 配置类型
SETUP_SERVER=$SETUP_SERVER
SETUP_WEB=$SETUP_WEB

# Python 命令
PYTHON_CMD="$PYTHON_CMD"

# 包管理器
PACKAGE_MANAGER="$PACKAGE_MANAGER"

# 后端配置
SERVER_DIR="server"
SERVER_MAIN="main.py"
SERVER_ENV_FILE=".env.development"
SERVER_PORT=$SERVER_PORT

# 前端配置
WEB_DIR="web"
WEB_START_COMMAND="run dev"
WEB_PORT=$WEB_PORT

# 其他配置
BACKEND_WAIT_TIME=3
EOF

chmod +x config.sh
echo -e "${GREEN}✓${NC} 已生成 config.sh"

echo ""
echo "步骤 5/5: 验证配置"
echo "----------------------------------------"

# 验证后端
if [ "$SETUP_SERVER" = true ]; then
    echo "验证后端配置..."
    if [ -f "server/main.py" ]; then
        echo -e "${GREEN}✓${NC} 后端主文件存在"
    else
        echo -e "${RED}✗${NC} 后端主文件不存在"
    fi

    if [ -f "server/requirements.txt" ]; then
        echo -e "${GREEN}✓${NC} 后端依赖文件存在"
    else
        echo -e "${RED}✗${NC} 后端依赖文件不存在"
    fi
fi

# 验证前端
if [ "$SETUP_WEB" = true ]; then
    echo "验证前端配置..."
    if [ -f "web/package.json" ]; then
        echo -e "${GREEN}✓${NC} 前端配置文件存在"
    else
        echo -e "${RED}✗${NC} 前端配置文件不存在"
    fi

    if [ -f "web/vite.config.js" ]; then
        echo -e "${GREEN}✓${NC} Vite 配置文件存在"
    else
        echo -e "${RED}✗${NC} Vite 配置文件不存在"
    fi
fi

echo ""
echo "========================================"
echo "  配置完成！"
echo "========================================"
echo ""
echo "检测到的配置："
if [ "$SETUP_SERVER" = true ]; then
    echo "  Python: $PYTHON_CMD"
    echo "  日志级别: $LOG_LEVEL"
    echo "  后端端口: $SERVER_PORT"
fi
if [ "$SETUP_WEB" = true ]; then
    echo "  包管理器: $PACKAGE_MANAGER"
    echo "  前端端口: $WEB_PORT"
fi
echo ""
echo "下一步："
if [ "$SETUP_SERVER" = true ] && [ "$SETUP_WEB" = true ]; then
    echo -e "  1. 运行 ${GREEN}./start.sh${NC} 启动系统"
    echo -e "  2. 访问 ${BLUE}http://localhost:$WEB_PORT${NC}"
    echo ""
    echo "其他命令："
    echo -e "  ${GREEN}./start.sh --server-only${NC}  只启动后端"
    echo -e "  ${GREEN}./start.sh --web-only${NC}     只启动前端"
elif [ "$SETUP_SERVER" = true ]; then
    echo -e "  1. 运行 ${GREEN}./start.sh --server-only${NC} 启动后端"
    echo -e "  2. 后端 API: ${BLUE}http://localhost:$SERVER_PORT${NC}"
elif [ "$SETUP_WEB" = true ]; then
    echo -e "  1. 运行 ${GREEN}./start.sh --web-only${NC} 启动前端"
    echo -e "  2. 访问 ${BLUE}http://localhost:$WEB_PORT${NC}"
fi
echo -e "  ${GREEN}./start.sh --help${NC}         查看帮助"
echo ""
